machine:
  # Version of python to use
  python:
    version:
      3.5.0

## Customize dependencies
dependencies:
  pre:
    - export PATH=$HOME/.local/bin:$PATH
    - mkdir -p ~/.local/bin
    - curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'

    - |
      if [ ! -d "$HOME/zeromq/lib" ]; then
          export OLDPWD=$(pwd)
          git clone http://www.github.com/zeromq/zeromq4-1.git libzmq
          mkdir $HOME/zeromq
          cd libzmq
          ./autogen.sh
          ./configure --prefix=$HOME/zeromq
          make
          make install
          cd $OLDPWD
      fi

    - pip install jupyter ipykernel notebook jupyter_client

  override:
    - |
        if [[ $CIRCLE_NODE_INDEX -eq 0 ]]; then
            export RESOLVER=lts-6.11
            export PEDANTIC=--pedantic
        else
            export RESOLVER=nightly-2016-08-13
            export PEDANTIC=
        fi

        stack --resolver=$RESOLVER setup

        # Set path for pkg-config to find zeromq, otherwise install of zeromq4-haskell fails.
        export PKG_CONFIG_PATH=$HOME/zeromq/lib/pkgconfig/
        stack --resolver=$RESOLVER build --dependencies-only --test

        # Write test.sh for use in the test command
        echo export LD_LIBRARY_PATH=$HOME/zeromq/lib > test.sh
        echo stack --resolver=$RESOLVER build >> test.sh
        echo stack --resolver=$RESOLVER exec kernel-basic install >> test.sh
        echo stack --resolver=$RESOLVER exec kernel-stdin install >> test.sh
        echo stack --resolver=$RESOLVER exec kernel-calculator install >> test.sh
        echo stack --resolver=$RESOLVER exec python python/tests.py >> test.sh
        echo stack --resolver=$RESOLVER test $PEDANTIC >> test.sh
        echo stack --resolver=$RESOLVER clean >> test.sh
        echo stack --resolver=$RESOLVER haddock '&>haddock.out' >> test.sh
        echo python python/ensure_haddock_coverage.py haddock.out >> test.sh
        chmod +x test.sh

  cache_directories:
    - "~/.ghc"
    - "~/.cabal"
    - "~/.stack"

## Customize test commands
test:
  override:
      - ./test.sh:
          parallel: true
