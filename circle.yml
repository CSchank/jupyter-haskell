machine:
  # Version of python to use
  python:
    version:
      3.5.0

## Customize dependencies
dependencies:
  pre:
    - export PATH=$HOME/.local/bin:$PATH
    - mkdir -p ~/.local/bin
    - curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'

    - |
      if [ ! -d "$HOME/zeromq/lib" ]; then
          export OLDPWD=$(pwd)
          git clone http://www.github.com/zeromq/zeromq4-x.git libzmq
          mkdir $HOME/zeromq
          cd libzmq
          ./autogen.sh
          ./configure --prefix=$HOME/zeromq
          make
          make install
          cd $OLDPWD
      fi

    - pip install jupyter ipykernel notebook jupyter_client

  override:
    - |
        if [[ $CIRCLE_NODE_INDEX -eq 0 ]]; then
            export RESOLVER=lts-6.11
        else
            export RESOLVER=nightly-2016-08-13
        fi

        stack --resolver=$RESOLVER setup

        # Set path for pkg-config to find zeromq, otherwise install of zeromq4-haskell fails.
        export PKG_CONFIG_PATH=$HOME/zeromq/lib/pkgconfig/
        stack --resolver=$RESOLVER build --dependencies-only

  cache_directories:
    - "~/.ghc"
    - "~/.cabal"
    - "~/.stack"
    - "~/zeromq/lib"

## Customize test commands
test:
  override:
    - |
        if [[ $CIRCLE_NODE_INDEX -eq 0 ]]; then
            export RESOLVER=lts-6.11
            export PEDANTIC=--pedantic
        else
            export RESOLVER=nightly-2016-08-13
            export PEDANTIC=
        fi

        export LD_LIBRARY_PATH=$HOME/zeromq/lib
        stack --resolver=$RESOLVER build
        stack --resolver=$RESOLVER exec kernel-basic install
        stack --resolver=$RESOLVER exec kernel-stdin install
        stack --resolver=$RESOLVER exec kernel-calculator install
        stack --resolver=$RESOLVER exec python python/tests.py
        stack --resolver=$RESOLVER test $PEDANTIC --resolver=$RESOLVER
        stack --resolver=$RESOLVER clean
        stack --resolver=$RESOLVER haddock &>haddock.out
        python python/ensure_haddock_coverage.py haddock.out
